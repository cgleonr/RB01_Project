---
title: "Nutritional Habits and their Relationship to Longevity"
author: "Carlos Leon, Kristian Zutter"
date: "`r Sys.Date()`"
output: html_document
---

# Table of Contents

1.  [Introduction](#introduction)
2.  [Data Description](#data-description)
3.  [Data Preparation](#data-preparation)
4.  [Exploratory Data Analysis](#exploratory-data-analysis)
5.  [Modeling](#modeling)
6.  [Chapter of Choice](#chapter-of-choice)
7.  [Conclusion](#conclusion)

```{r setup, include=FALSE}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(gganimate) # animates ggplots
library(maptiles) # download tiles from a large number of providers
library(tidyterra) # add background map/tiles to ggplot2

```

```{r Data Loading and Prep, cache=TRUE, include=FALSE}

df <- read.csv("../clean_datasets/final_df.csv")

# Filter only 2019 values
df_2019 <- df %>% filter(Year == 2019)

# Remove duplicates and sort by Life.Expectancy
df_2019_unique <- df_2019 %>% 
  distinct(Country, .keep_all = TRUE) %>% 
  arrange(desc(Life.Expectancy))
df_2019_unique

# Calculate the middle 10 indices
mid_start <- round(length(df_2019_unique[,1])/2 - 5)
mid_end <- round(length(df_2019_unique[,1])/2 + 4)

# Select top 10, middle 10, and bottom 10 countries
top_10 <- df_2019_unique %>% slice(1:10) %>% mutate(Category = "Top")
mid_10 <- df_2019_unique %>% slice(mid_start:mid_end) %>% mutate(Category = "Mid")
mid_10 <- mid_10 %>% slice(-9) %>% mutate(Category = "Mid") # grabs 11, but #9 has a char error
bot_10 <- df_2019_unique %>% slice((n() - 9):n()) %>% mutate(Category = "Bot")

# Combine them into one dataframe
subset_df <- bind_rows(top_10, mid_10, bot_10)


# Filter the original dataframe for the selected countries and years
df_filtered <- df %>%
  filter(Country %in% subset_df$Country, Year >= 2015, Year <= 2019) %>%
  left_join(subset_df %>% select(Country, Category), by = "Country")

# Filter the dataset for total caloric intake
caloric_data <- df %>%
  filter(Element == "Food supply (kcal/capita/day)" & Unit == "kcal/cap/d") %>%
  group_by(Country, Year) %>%
  summarize(Total_Calories = sum(Value, na.rm = TRUE)/2) #2 because total was both sexes

life_exp <- df %>% 
  select(Country, Year, Life.Expectancy)

# Merge caloric data with life expectancy data
merged_df <- caloric_data %>%
  left_join(life_exp, by = c("Country", "Year"))

# select distinct
unique_data <- merged_df %>%
  distinct(Country, Year, .keep_all = TRUE)

# Calculating differences in cal intake and LE
difference_data <- unique_data %>%
  group_by(Country) %>%
  reframe(
    Caloric_Intake_Diff = Total_Calories[Year == 2019] - Total_Calories[Year == 2015],
    Life_Expectancy_Diff = Life.Expectancy[Year == 2019] - Life.Expectancy[Year == 2015]
  )


# Select the 'Country' and 'Category' columns
category_data <- subset_df %>% 
  select(Country, Category) %>% 
  distinct()

# Merge the category information into difference_data
difference_data <- difference_data %>%
  left_join(category_data, by = "Country")

# Add total calories to difference_data

# View the updated dataframe
diff_vis_data <- na.omit(diff)

#join trends to tables
subset_df <- subset_df %>%
  left_join(difference_data %>% select(Country, Total_Calories, Caloric_Intake_Diff, Life_Expectancy_Diff),
            by = "Country")

```

# Introduction {#introduction}

<a name="introduction"></a>

*Provide a brief introduction to your project, including the objectives and any background information.*

*Describe the datasets you are using, their sources, and any relevant information about the variables included.*

# Theoretical Focus

<a name="theoretical-focus"></a>

# Data Preparation {#data-preparation}

<a name="data-preparation"></a>

*Detail the steps taken to clean and prepare the data for analysis. Include any data transformations, handling of missing values, and data merging.*

# Exploratory Data Analysis {#exploratory-data-analysis}

<a name="exploratory-data-analysis"></a>

## Life Expectancy Categories {.tabset}

### Top

```{r Top 10, echo=FALSE}
# Display the top countries sorted by Life.Expectancy in descending order
top_countries <- subset_df %>% 
  filter(Category == "Top") %>% 
  arrange(desc(Life.Expectancy))

print(top_countries[,c("Country","Total.Calories","Life.Expectancy", "Caloric_Intake_Diff", "Life_Expectancy_Diff")])
```

### Middle

```{r Middle 10, echo=FALSE}
# Display the mid countries sorted by Life.Expectancy in descending order
mid_countries <- subset_df %>% 
  filter(Category == "Mid") %>% 
  arrange(desc(Life.Expectancy))

print(mid_countries[,c("Country","Life.Expectancy", "Caloric_Intake_Diff", "Life_Expectancy_Diff")])
```

### Bottom

```{r Bottom 10, echo=FALSE}
# Display the bottom countries sorted by Life.Expectancy in descending order
bot_countries <- subset_df %>% 
  filter(Category == "Bot") %>% 
  arrange(desc(Life.Expectancy))

print(bot_countries[,c("Country","Life.Expectancy", "Caloric_Intake_Diff", "Life_Expectancy_Diff")])
```

## Trends Through the Years

```{r Trends/Differences, echo=FALSE, warning=FALSE, message=FALSE}
# Filter the dataset for total caloric intake
caloric_data <- df %>%
  filter(Element == "Food supply (kcal/capita/day)" & Unit == "kcal/cap/d") %>%
  group_by(Country, Year) %>%
  summarize(Total_Calories = sum(Value, na.rm = TRUE)/2) #2 because total was both sexes

life_exp <- df %>% 
  select(Country, Year, Life.Expectancy)

# Merge caloric data with life expectancy data
merged_df <- caloric_data %>%
  left_join(life_exp, by = c("Country", "Year"))

# select distinct
unique_data <- merged_df %>%
  distinct(Country, Year, .keep_all = TRUE)
# Cals Consumed vs Life Expectancy
ggplot(unique_data, aes(x = Total_Calories, y = Life.Expectancy)) +
  geom_point(aes(color = as.factor(Year)), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  labs(title = "Relationship Between Total Caloric Intake and Life Expectancy",
       x = "Total Calories Consumed (kcal/capita/day)",
       y = "Life Expectancy (Years)",
       color = "Year") +
  theme_minimal()

#summary(lm(Life.Expectancy~Total_Calories, unique_data))


```

*Provide visualizations and summary statistics that give an overview of the data. Discuss any patterns, trends, or interesting observations.*

# Modeling {#modeling}

<a name="modeling"></a>

*Describe the modeling techniques you are using. Include any relevant code, and discuss the results of your models.*

# Chapter of Choice {#chapter-of-choice}

<a name="chapter-of-choice"></a>

*This section should showcase a method, package, or technique not covered in the main part of the course. Describe the chosen topic and demonstrate its application in your project.*

# Conclusion {#conclusion}

<a name="conclusion"></a>

*Summarize your findings, discuss the implications of your results, and consider any limitations of your analysis. Provide suggestions for future work or potential improvements.*
